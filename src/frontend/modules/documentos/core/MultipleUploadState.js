import { CONFIG } from '../../../config.js';
import { formatFileSize, showAlert } from '../../../utils.js';

/**
 * Clase que gestiona el estado completo de la subida mÃºltiple de archivos.
 * Controla archivos pendientes, en progreso, completados y fallidos,
 * asÃ­ como configuraciones comunes para todos los archivos.
 */
export class MultipleUploadState {
    constructor() {
        this.reset();
    }

    /**
     * Reinicia completamente el estado de subida mÃºltiple.
     * Ãštil para comenzar una nueva sesiÃ³n de subida.
     */
    reset() {
        this.files = [];
        this.currentUploads = [];
        this.completedUploads = [];
        this.failedUploads = [];
        this.isUploading = false;
        this.totalSize = 0;
        this.commonCategory = '';
        this.commonPersonId = '';
        this.expirationDays = null;
        this.uploadStrategy = 'sequential';
        this.autoGenerateDescriptions = true;
        this.notifyPerson = false;
    }

    /**
     * Agrega nuevos archivos al estado, validando cada uno individualmente.
     * Evita duplicados y aplica validaciones de tipo y tamaÃ±o.
     * @param {File[]} newFiles - Array de archivos a agregar
     */
    addFiles(newFiles) {
        console.group('ðŸ“¦ Agregando archivos mÃºltiples');
        
        for (const file of newFiles) {
            // Verificar si ya existe
            const existingFile = this.files.find(f => 
                f.name === file.name && f.size === file.size
            );
            
            if (!existingFile) {
                // Validar archivo individual
                if (this.validateSingleFile(file)) {
                    const fileObj = {
                        file: file,
                        id: this.generateFileId(file),
                        status: 'pending',
                        progress: 0,
                        error: null,
                        description: file.name.replace(/\.[^/.]+$/, ""), // Nombre sin extensiÃ³n
                        customCategory: '',
                        customPersonId: '',
                        customExpirationDate: null
                    };
                    
                    this.files.push(fileObj);
                    this.totalSize += file.size;
                    
                    console.log(`âœ… Archivo agregado: ${file.name} (${formatFileSize(file.size)})`);
                }
            } else {
                console.log(`âš ï¸ Archivo duplicado ignorado: ${file.name}`);
            }
        }
        
        console.log(`ðŸ“Š Total archivos: ${this.files.length}, TamaÃ±o total: ${formatFileSize(this.totalSize)}`);
        console.groupEnd();
    }

    /**
     * Elimina un archivo del estado por su ID.
     * @param {string} fileId - ID Ãºnico del archivo a eliminar
     * @returns {boolean} - True si se eliminÃ³ correctamente
     */
    removeFile(fileId) {
        const index = this.files.findIndex(f => f.id === fileId);
        if (index !== -1) {
            const removedFile = this.files[index];
            this.totalSize -= removedFile.file.size;
            this.files.splice(index, 1);
            console.log(`ðŸ—‘ï¸ Archivo removido: ${removedFile.file.name}`);
            return true;
        }
        return false;
    }

    /**
     * Valida un archivo individual segÃºn configuraciones del sistema.
     * Verifica tipo de archivo, tamaÃ±o individual y tamaÃ±o total acumulado.
     * @param {File} file - Archivo a validar
     * @returns {boolean} - True si el archivo es vÃ¡lido
     */
    validateSingleFile(file) {
        try {
            console.log(`ðŸ” Validando archivo: ${file.name}`);
            
            // Validar tipo de archivo
            const fileExtension = file.name.split('.').pop().toLowerCase();
            if (!CONFIG.ALLOWED_FILE_TYPES.includes(fileExtension)) {
                console.error(`âŒ Tipo no permitido: ${fileExtension}`);
                showAlert(
                    `"${file.name}" - Tipo no permitido. Formatos aceptados: ${CONFIG.ALLOWED_FILE_TYPES.join(', ').toUpperCase()}`,
                    'error'
                );
                return false;
            }

            // Validar tamaÃ±o individual
            if (file.size > CONFIG.MAX_FILE_SIZE) {
                console.error(`âŒ TamaÃ±o excedido: ${formatFileSize(file.size)} > ${formatFileSize(CONFIG.MAX_FILE_SIZE)}`);
                showAlert(
                    `"${file.name}" - Excede el tamaÃ±o mÃ¡ximo por archivo (${formatFileSize(CONFIG.MAX_FILE_SIZE)})`,
                    'error'
                );
                return false;
            }

            // Validar tamaÃ±o total (si ya hay archivos)
            if (this.totalSize + file.size > CONFIG.MAX_TOTAL_UPLOAD_SIZE) {
                console.error(`âŒ TamaÃ±o total excedido`);
                showAlert(
                    `"${file.name}" - Excede el tamaÃ±o total permitido para mÃºltiples archivos`,
                    'error'
                );
                return false;
            }

            console.log(`âœ… Archivo vÃ¡lido: ${file.name}`);
            return true;

        } catch (error) {
            console.error(`âŒ Error validando archivo ${file.name}:`, error);
            showAlert(`Error validando "${file.name}": ${error.message}`, 'error');
            return false;
        }
    }

    /**
     * Valida todos los archivos en el estado globalmente.
     * Verifica lÃ­mites, categorÃ­as y otros requisitos del sistema.
     * @returns {boolean} - True si todos los archivos son vÃ¡lidos
     */
    validateAllFiles() {
        console.group('ðŸ” Validando todos los archivos');
        
        const errors = [];
        
        // Verificar lÃ­mite de archivos
        if (this.files.length > CONFIG.MAX_MULTIPLE_FILES) {
            errors.push(`MÃ¡ximo ${CONFIG.MAX_MULTIPLE_FILES} archivos permitidos`);
        }

        // Verificar tamaÃ±o total
        if (this.totalSize > CONFIG.MAX_TOTAL_UPLOAD_SIZE) {
            errors.push(`TamaÃ±o total excedido (${formatFileSize(this.totalSize)} > ${formatFileSize(CONFIG.MAX_TOTAL_UPLOAD_SIZE)})`);
        }

        // Verificar que haya archivos
        if (this.files.length === 0) {
            errors.push('No hay archivos seleccionados');
        }

        // Verificar categorÃ­a si se requiere
        if (this.commonCategory === '' && this.files.some(f => f.customCategory === '')) {
            errors.push('Debe seleccionar una categorÃ­a para todos los archivos o individualmente');
        }

        if (errors.length > 0) {
            console.error('âŒ Errores de validaciÃ³n:', errors);
            errors.forEach(error => showAlert(error, 'error'));
            console.groupEnd();
            return false;
        }

        console.log('âœ… Todos los archivos son vÃ¡lidos');
        console.groupEnd();
        return true;
    }

    /**
     * Genera un ID Ãºnico para un archivo basado en nombre, tamaÃ±o y timestamp.
     * @param {File} file - Archivo para generar ID
     * @returns {string} - ID Ãºnico del archivo
     */
    generateFileId(file) {
        return `${file.name}_${file.size}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    }

    /**
     * Obtiene estadÃ­sticas actuales del estado de subida.
     * @returns {object} - Objeto con conteos de archivos por estado y tamaÃ±os
     */
    getStats() {
        return {
            total: this.files.length,
            pending: this.files.filter(f => f.status === 'pending').length,
            uploading: this.files.filter(f => f.status === 'uploading').length,
            completed: this.files.filter(f => f.status === 'completed').length,
            failed: this.files.filter(f => f.status === 'failed').length,
            totalSize: this.totalSize,
            uploadedSize: this.files
                .filter(f => f.status === 'completed')
                .reduce((sum, f) => sum + f.file.size, 0)
        };
    }

    /**
     * Muestra en consola el estado actual de la subida mÃºltiple.
     * Ãštil para debugging y seguimiento de progreso.
     */
    logState() {
        console.group('ðŸ“Š Estado de Subida MÃºltiple');
        const stats = this.getStats();
        console.table({
            'Total Archivos': stats.total,
            'Pendientes': stats.pending,
            'Subiendo': stats.uploading,
            'Completados': stats.completed,
            'Fallidos': stats.failed,
            'TamaÃ±o Total': formatFileSize(stats.totalSize),
            'Subido': formatFileSize(stats.uploadedSize)
        });
        console.groupEnd();
    }
}